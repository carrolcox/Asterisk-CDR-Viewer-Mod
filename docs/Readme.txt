===============================================
 Системные требования
===============================================

PHP 5.3 и выше
База данных Mysql
Веб-сервер Apache или Nginx


===============================================
 Для чего файл "Старый код form.tpl.txt" ?
===============================================

Из файла "templates/form.tpl" вырезан лишний функционал. Однако для тех, кому этот функционал необходим, могут его очень просто вернуть.
В файле "templates/form.tpl" оставлены комментарии точно в тех местах, откуда было вырезано. В файле "Старый код form.tpl.txt" можно найти такие же комментарии.
Ниже комментария в этом файле расположен код, который был вырезан. Если вам нужен какой-либо вырезанный функционал, просто берете код из этого файла и
вставляете вместо комментария в файл "templates/form.tpl".

===============================================
 Создание таблицы в базе
===============================================

Имя файла записи разговора будет храниться в базе Mysql. Как настроить Asterisk для работы с MySql можно найти в интернете. / http://blog.thecall.ru/page/asterisk-18-cdr-v-mysql-cdr_adaptive_odbc /
Допусти мы настроили Asterisk для работы с базой и уже создали таблицу, например "cdr". Теперь нам необходимо добавить с нашу таблицу новую колонку, например "filename", в которой будет
имя файла с записью, удобнее это сделать через phpmyadmin. Название колонки можно задать в конфиге. / `filename` varchar(255) DEFAULT 'none' / 

===============================================
 Настройка Asterisk
===============================================

Все изменения производим в extensions.ael, либо в extensions.conf. В зависимости от того, в какой файле у нас написан диалплан.

Если название столбца, в котором хранится название записи звонка у вас отличается от "filename", то необходимо внести соответствующие изменения в диалплан.
Необходимо изменить строку "Set(CDR(filename)=${fname}.mp3);", на "Set(CDR(название_столбца)=${fname}.mp3);"

==
 Для extensions.ael, extensions.conf
==

В "globals" добавим пару переменных:

RECORDING=1;	// 1-вкл / 0-выкл запись разговора
DIR_RECORDS=/var/calls/;	// папка с записями разговоров

Добавим макрос.
Сразу уточним, что в этом макросе запись прямо во время разговора конвертируется в MP3.

==
 Для extensions.ael
==

// MixMonitor
macro recording(calling,called) {
	if ("${RECORDING}" = "1") {
		Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${calling}-${called});
		Set(monopt=nice -n 19 /usr/bin/lame -b 32  --silent "${DIR_RECORDS}${fname}.wav"  "${DIR_RECORDS}${fname}.mp3" && rm -f "${DIR_RECORDS}${fname}.wav" && chmod o+r "${DIR_RECORDS}${fname}.mp3");
		Set(CDR(filename)=${fname}.mp3);
		Set(CDR(realdst)=${called});
		MixMonitor(${DIR_RECORDS}${fname}.wav,b,${monopt});
   }
   return;
};

Пример вызова макроса:
context internal {
	_X. => {
		&recording(${CALLERID(num)},${EXTEN});
		Dial(SIP/${EXTEN},60);
		Hangup();
	};
};

==
 Для extensions.conf
==

; MixMonitor
[macro-recording]
exten => s,1,GoToIf($["${RECORDING}" = "1"]?yes:no)
exten => s,n(yes),Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${ARG1}-${ARG2});
exten => s,n,Set(monopt=nice -n 19 /usr/bin/lame -b 32  --silent "${DIR_RECORDS}${fname}.wav"  "${DIR_RECORDS}${fname}.mp3" && rm -f "${DIR_RECORDS}${fname}.wav" && chmod o+r "${DIR_RECORDS}${fname}.mp3");
exten => s,n,Set(CDR(filename)=${fname}.mp3);
exten => s,n,Set(CDR(realdst)=${ARG2});
exten => s,n,MixMonitor(${DIR_RECORDS}${fname}.wav,b,${monopt});
exten => s,n(no),Verbose(Exit record);

Пример вызова макроса:
[internal]
exten => _X.,1,Macro(recording,${CALLERID(num)},${EXTEN})
exten => _X.,n,Dial(SIP/${EXTEN},60)
exten => _X.,n,Hangup()

====
 Дополнительно (необязательно)
====

В Asterisk если используется макрос, то звонок совершается с экстеншеном s. Чтобы Номер назначения был действительным, а не s или ~~s~~, то сделаем следующее:
Через phpMyAdmin. В таблицу нужно добавить новое поле "realdst" с типом "varchar" и размером "80". Теперь нужно добавить триггер на таблицу.
Для этого зайдем в Триггеры - Добавить триггер. Назначаем имя триггеру, остальное оставляем без изменений. В поле "Определение" вставляем текст ниже (то, что начинается на // - не вставлять):
//-- Начало --//
BEGIN
	IF ((NEW.dst = 's' OR NEW.dst = '~~s~~') AND NEW.realdst != '') THEN 
		SET NEW.dst = NEW.realdst;
	END IF;
END
//-- / Конец --//

Для того, чтобы в поле "realdst" записывался правильный Номер назначения, нужно в отредактировать диалплан. Макрос выше в редактировании не нуждается.
В используемом у вас макросе необходимо добавить строчку, это только пример. Задайте правильные имена параметров (${number}, ${ARG1}).
==
 Для extensions.ael
==
Set(CDR(realdst)=${number});

==
 Для extensions.conf
==
exten => s,n,Set(CDR(realdst)=${ARG1});



===============================================
 Настройка папки со звонками
===============================================

Записи разговоров будут складываться в папку "/var/calls/" из примера выше.

Есть два варианта хранения файлов записей.
1. Все записи разговоров хранятся в одной папке.
2. Записи разговоров должны распределяться по папкам в соответствии с датой. 

Все это можно настроить в конфиге.

==
 Для 2 варианта
==

Каждый день в 00.01 часов записи из папки "/var/calls/" по CRON должны распределяться по дате
в соответствующие папки.

Формат хранения записей (пример):
1. /var/calls/2014/2014-09/2014-09-29
2. /var/calls/2014/09/29

Примерный скрипт для распределения файлов:
1.
===
#!/bin/bash
y=`date +%Y`
ym=`date +%Y-%m -d "-1 day"`
ymd=`date +%Y-%m-%d -d "-1 day"`
mkdir -p /var/calls/$y/$ym/$ymd/
mv /var/calls/*$ymd* /var/calls/$y/$ym/$ymd/
===

2.
===
#!/bin/bash
y=`date +%Y`
m=`date +%m -d "-1 day"`
d=`date +%d -d "-1 day"`
ymd=`date +%Y-%m-%d -d "-1 day"`
mkdir -p /var/calls/$y/$m/$d/
mv /var/calls/*$ymd* /var/calls/$y/$m/$d/
===

==
 Для вариантов, когда Asterisk сам распределяет записи по папкам в соответствии с датой.
==

Если у вас Asterisk сам распределяет записи звонков по папкам в соответствии с датой, тогда необходимости запуска скрипта по CRON нет.
Возможные форматы хранения записей:
1. /var/calls/2014/2014-09/2014-09-29
2. /var/calls/2014/09/29

===============================================
 Настройка скрипта
===============================================

Все настройки скрипта прописаны в файле "inc/config.inc.php" с подробными комментариями, тут не должно возникнуть сложностей.
Также в файле "img/script.js" прописаны настройки воспроизведения записей звонков.

Кратко:
1. Скачать ZIP архив с GitHub или выполнить git clone git@github.com:prog-it/Asterisk-CDR-Viewer-Mod.git
2. Распаковать / перенести файлы в нужную папку на сервере
3. Настроить параметры в "inc/config.inc.php"
4. Почти готово. Если необходим доступ только для определенных пользователей, то необходимо создать файл .htpasswd

htpasswd -c /path/to/.htpasswd admin

Пример конфига для Nginx:
===
location /path/to/script {
	auth_basic "Asterisk";
	auth_basic_user_file /path/to/.htpasswd;
}
===

Пример конфига для Apache:
===
<Location "/path/to/script">
	AuthName "Asterisk"
	AuthType Basic
	AuthUserFile /path/to/.htpasswd
	AuthGroupFile /dev/null
	require valid-user
</Location>
===

5. Прописать в конфиге скрипта имена пользователей, которым разрешен доступ
===
$admin_user_names = 'admin1,admin2,admin3';
===


===============================================
 Настройка тарифов на звонки
===============================================

Тарифы на звонки задаются в файле gen_callrates.csv. Его имя можно изменить в конфиге.

Формат задания тарифы в CSV файле:
Код_региона,стоимость_минуты[,Направление,Тип_тарификации,Доп_тариф]

-- То, что в фигурных скобках - необязательно

Пример для Мегафона, с поминутной тарификацией, стоимость первой минуты 90 коп., после первой минуты 10 коп.
===
8922,0.90,Мегафон,m,0.10
===

Типы тарификации:
	s		- посекундно (нет доп. тарифа)
	m		- поминутно (есть доп. тариф)
	c		- за весь звонок (нет доп. тарифа)
	1m+s	- посекундно со 2 минуты (есть доп. тариф)
	30s+s	- посекундно  после 30 секунды
	30s+6s	- 

===============================================

Остальное можно прочитать с файле "Старый ReadMe.txt"	
	
	
